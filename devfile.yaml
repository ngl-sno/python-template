schemaVersion: 2.2.2
metadata:
  name: ngl-python-fastapi-template
components:
  - name: python
    container:
      image: registry.redhat.io/devspaces/udi-rhel9:3.18
      volumeMounts:
        - name: venv
          path: /home/user/.venv
      memoryLimit: '2Gi'
      memoryRequest: '1Gi'
      cpuLimit: '2'
      cpuRequest: '1'
      mountSources: true
      endpoints:
        - name: port-8000
          targetPort: 8000
          exposure: internal
  - name: venv
    volume:
      ephemeral: false
      size: 1G
commands:
  - id: install-requirements-setup-continue
    exec:
      label: "Install requirements and setup continue extension"
      component: python
      workingDir: ${PROJECTS_ROOT}/python-template
      commandLine: "python -m venv .venv && . .venv/bin/activate && pip install -r requirements.txt && cp -p /etc/secret/continue-config-secret/config.json /home/user/.continue/config.json"
      group:
        kind: build
        isDefault: true
  - id: start-fastapi-server
    exec:
      label: "Start FastAPI server"
      component: python
      workingDir: ${PROJECTS_ROOT}/python-template
      commandLine: uvicorn server:app --reload
      group:
        kind: run
        isDefault: true
  # - id: run
  #   exec:
  #     label: "Run the application"
  #     component: python
  #     workingDir: ${PROJECTS_ROOT}/python-template
  #     commandLine: python -m venv .venv && . .venv/bin/activate && python hello-world.py
  #     group:
  #       kind: run

  # - id: copyconfig
  #   exec:
  #     component: python
  #     commandLine: "echo 'copy config.json' && cp -p /etc/secret/continue-config-secret/config.json /home/user/.continue/config.json"

# events:
  # preStart:
    # - copyconfig
  # postStart:
  #   - copyconfig
  # preStop:
  #   - command3
  # postStop:
  #   - command4  

#   - id: copyconfig
#     exec:
#       component: python
#       commandLine: "[[ ! -d /home/user/.continue ]] && mkdir /home/user/.continue && cp /projects/python-template/.continue.example/config.json /home/user/.continue/config.json"
# events:
#   postStart:
#     - copyconfig